{
  "rules": {
    // ========================================
    // CONTENT - Public read, admin write only
    // ========================================
    "content": {
      ".read": true,
      ".write": "auth != null && root.child('admins').child(auth.uid).exists()"
    },

    // ========================================
    // PAGES - Public read, admin write only
    // ========================================
    "pages": {
      ".read": true,
      ".write": "auth != null && root.child('admins').child(auth.uid).exists()"
    },

    // ========================================
    // BENEFITS - Controlled access
    // ========================================
    "benefits": {
      // Cache: Public read, only authenticated workers can write
      "cache": {
        ".read": true,
        ".write": "auth != null",
        "$cacheKey": {
          ".validate": "newData.hasChildren(['benefits', 'usageTips', 'cachedAt']) &&
                        newData.child('benefits').isString() == false &&
                        newData.child('cachedAt').isNumber()"
        }
      },
      // History: Public read/write with validation
      "history": {
        ".read": true,
        ".write": true,
        "$historyId": {
          ".validate": "newData.hasChildren(['query', 'timestamp']) &&
                        newData.child('query').isString() &&
                        newData.child('query').val().length <= 200 &&
                        newData.child('timestamp').isNumber()"
        }
      },
      // Expansions: Public read, only authenticated can write
      "expansions": {
        ".read": true,
        ".write": "auth != null",
        "$expansionKey": {
          ".validate": "newData.hasChildren(['expansion', 'cachedAt'])"
        }
      }
    },

    // ========================================
    // STICKY NOTES - Rate limited, validated
    // ========================================
    "stickynotes": {
      ".read": true,
      "$noteId": {
        // Anyone can create, only admin can delete existing
        ".write": "!data.exists() || (auth != null && root.child('admins').child(auth.uid).exists())",
        ".validate": "newData.hasChildren(['text', 'x', 'y', 'color', 'createdAt']) &&
                      newData.child('text').isString() &&
                      newData.child('text').val().length >= 1 &&
                      newData.child('text').val().length <= 200 &&
                      newData.child('x').isNumber() &&
                      newData.child('y').isNumber() &&
                      newData.child('createdAt').isNumber()"
      }
    },

    // ========================================
    // DRAWING STROKES - Public with validation
    // ========================================
    "strokes": {
      ".read": true,
      "$pageId": {
        // Validate page ID is a known page
        ".validate": "$pageId.matches(/^[a-zA-Z0-9_-]+$/)",
        "$strokeId": {
          ".write": true,
          ".validate": "newData.hasChildren(['points', 'width', 'timestamp']) &&
                        newData.child('width').isNumber() &&
                        newData.child('width').val() >= 1 &&
                        newData.child('width').val() <= 50 &&
                        newData.child('timestamp').isNumber() &&
                        newData.child('points').hasChildren()"
        }
      }
    },

    // ========================================
    // CANVAS CLEARED - Admin only
    // ========================================
    "canvas_cleared": {
      ".read": true,
      "$pageId": {
        ".write": "auth != null && root.child('admins').child(auth.uid).exists()",
        ".validate": "newData.isNumber()"
      }
    },

    // ========================================
    // COMMAND CENTER - Strict admin control
    // ========================================
    "commandcenter": {
      "enabled": {
        ".read": true,
        ".write": "auth != null && root.child('admins').child(auth.uid).exists()",
        ".validate": "newData.isBoolean()"
      },
      "devices": {
        ".read": true,
        ".write": "auth != null && root.child('admins').child(auth.uid).exists()"
      },
      "log": {
        ".read": "auth != null && root.child('admins').child(auth.uid).exists()",
        "$logId": {
          ".write": true,
          ".validate": "newData.hasChildren(['entity_id', 'action', 'timestamp']) &&
                        newData.child('timestamp').isNumber()"
        }
      }
    },

    // ========================================
    // MUSIC - Public collaborative feature
    // ========================================
    "music": {
      ".read": true,
      "bars": {
        "$barId": {
          ".write": true,
          ".validate": "newData.hasChildren(['drums', 'melody'])"
        }
      },
      "songs": {
        "$songId": {
          ".write": true
        }
      }
    },

    // ========================================
    // LITTER ROBOT - Read only (external update)
    // ========================================
    "litterrobot": {
      ".read": true,
      ".write": false
    },

    // ========================================
    // ADMIN CONFIG - Never publicly accessible
    // ========================================
    "admins": {
      "$uid": {
        ".read": "auth != null && auth.uid == $uid",
        ".write": false
      }
    },
    "admin_config": {
      ".read": "auth != null && root.child('admins').child(auth.uid).exists()",
      ".write": "auth != null && root.child('admins').child(auth.uid).exists()"
    },

    // ========================================
    // DEFAULT - Deny all other paths
    // ========================================
    "$other": {
      ".read": false,
      ".write": false
    }
  }
}
