<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Scott Friedman</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            color: #1a1a1a;
            line-height: 1.6;
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        h2 { font-size: 1.1rem; margin: 2rem 0 1rem; color: #2d5a3d; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        h3 { font-size: 0.95rem; color: #666; margin-bottom: 0.75rem; }
        .subtitle { color: #666; margin-bottom: 2rem; }

        /* Tabs */
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .tab {
            padding: 0.6rem 1.2rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .tab:hover { border-color: #2d5a3d; }
        .tab.active { background: #2d5a3d; color: white; border-color: #2d5a3d; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Login */
        #login-screen { text-align: center; padding: 4rem 2rem; }
        #login-screen input {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 1rem;
        }
        #login-screen button {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            background: #2d5a3d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #login-screen button:hover { background: #1e3d29; }
        .error { color: #c45d3a; margin-top: 1rem; }

        /* Admin panel */
        #admin-panel { display: none; }
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.9rem;
        }
        .label-hint { font-weight: normal; color: #999; font-size: 0.8rem; }
        input, textarea, select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            font-size: 0.95rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-family: inherit;
        }
        textarea { min-height: 80px; resize: vertical; }
        textarea.large { min-height: 200px; }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #2d5a3d;
        }
        .inline-fields { display: flex; gap: 0.5rem; }
        .inline-fields input { flex: 1; }
        .inline-fields select { width: auto; min-width: 120px; }

        /* Items list */
        .item {
            background: #f9f9f9;
            padding: 1rem;
            padding-left: 2.5rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            position: relative;
            transition: all 0.15s ease;
        }
        .item input, .item textarea, .item select { margin-bottom: 0.5rem; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .item-title { font-weight: 500; font-size: 0.9rem; }
        .remove-btn {
            background: none;
            border: none;
            color: #c45d3a;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
        }
        .remove-btn:hover { color: #a33d1a; }

        /* Order controls */
        .order-controls {
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .order-input {
            width: 28px !important;
            height: 24px;
            text-align: center;
            padding: 2px !important;
            font-size: 0.75rem !important;
            margin: 0 !important;
            border-radius: 4px;
        }
        .order-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 16px;
            font-size: 0.6rem;
            color: #888;
            line-height: 1;
        }
        .order-btn:hover { background: #eee; color: #333; }

        /* Section reordering */
        .section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            transition: all 0.15s ease;
        }
        .section-order-controls {
            position: absolute;
            right: 1rem;
            top: 1rem;
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        .section-order-input {
            width: 32px !important;
            height: 26px;
            text-align: center;
            padding: 2px !important;
            font-size: 0.8rem !important;
            margin: 0 !important;
        }
        .section-order-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: #666;
        }
        .section-order-btn:hover { background: #e0e0e0; }

        .add-btn {
            background: #f0f0f0;
            border: 2px dashed #ccc;
            padding: 0.75rem;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .add-btn:hover { border-color: #2d5a3d; color: #2d5a3d; }

        /* Page list */
        .page-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9f9f9;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .page-item-info { flex: 1; }
        .page-item-title { font-weight: 500; }
        .page-item-slug { font-size: 0.8rem; color: #666; }
        .page-item-actions { display: flex; gap: 0.5rem; }
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .btn-edit { background: #e8e8e8; color: #333; }
        .btn-edit:hover { background: #ddd; }
        .btn-delete { background: #fde8e8; color: #c45d3a; }
        .btn-delete:hover { background: #fcd8d8; }

        /* Save button */
        .save-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 1rem;
            z-index: 100;
        }
        .save-btn {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            background: #2d5a3d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .save-btn:hover { background: #1e3d29; }
        .save-btn:disabled { background: #999; cursor: not-allowed; }
        .status { padding: 0.75rem; color: #666; }
        .status.success { color: #2d5a3d; }
        .status.error { color: #c45d3a; }

        /* Logout */
        .logout-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: none;
            border: 1px solid #ddd;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            color: #666;
            z-index: 101;
        }
        .logout-btn:hover { border-color: #c45d3a; color: #c45d3a; }

        body { padding-bottom: 5rem; }

        /* Page editor modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { margin: 0; border: none; padding: 0; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        .modal-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .btn-primary { background: #2d5a3d; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; }
        .btn-primary:hover { background: #1e3d29; }
        .btn-secondary { background: #e8e8e8; color: #333; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; }
        .btn-secondary:hover { background: #ddd; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen">
        <h1>Admin Login</h1>
        <p class="subtitle">Enter your password to manage content</p>
        <input type="password" id="password-input" placeholder="Password" autofocus>
        <br>
        <button onclick="login()">Login</button>
        <p id="login-error" class="error"></p>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
        <button class="logout-btn" onclick="logout()">Logout</button>

        <h1>Content Manager</h1>
        <p class="subtitle">Edit your website content</p>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('home')">Home Page</button>
            <button class="tab" onclick="showTab('pages')">Pages</button>
            <button class="tab" onclick="showTab('commandcenter')">Command Center</button>
        </div>

        <!-- Home Page Tab -->
        <div id="tab-home" class="tab-content active">
            <p style="color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
                Drag sections by the handle to reorder. Drag items within sections to reorder.
            </p>
            <div id="sections-container">
                <!-- Sections will be rendered dynamically based on sectionOrder -->
            </div>
        </div>

        <!-- Pages Tab -->
        <div id="tab-pages" class="tab-content">
            <div class="section">
                <h2>Your Pages</h2>
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
                    Create pages for projects, blog posts, or anything else. Link to them using: <code>page.html?p=your-slug</code>
                </p>
                <div id="pages-list"></div>
                <button class="add-btn" onclick="openPageEditor()">+ Create New Page</button>
            </div>
        </div>

        <!-- Command Center Tab -->
        <div id="tab-commandcenter" class="tab-content">
            <div class="section">
                <h2>Command Center Settings</h2>
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
                    Control public access to your smart home devices. When enabled, visitors can toggle your devices.
                </p>

                <!-- Enable/Disable Toggle -->
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f9f9f9; border-radius: 8px;">
                    <span style="font-weight: 500;">Public Controls:</span>
                    <button id="cc-toggle-btn" class="btn-small" onclick="toggleCommandCenter()" style="padding: 0.5rem 1rem;">
                        Loading...
                    </button>
                    <span id="cc-status" style="color: #666; font-size: 0.85rem;"></span>
                </div>

                <h3>Devices</h3>
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
                    Configure which devices visitors can control. You'll need entity IDs from Home Assistant.
                </p>
                <div id="cc-devices-container"></div>
                <button class="add-btn" onclick="addCCDevice()">+ Add Device</button>
                <button class="save-btn" onclick="saveCCDevices()" style="margin-top: 1rem; width: 100%;">Save Devices</button>
                <span id="cc-save-status" class="status" style="display: block; text-align: center; margin-top: 0.5rem;"></span>
            </div>

            <div class="section">
                <h2>Activity Log</h2>
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
                    Recent actions taken by visitors.
                </p>
                <div id="cc-activity-log" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #999; text-align: center;">Loading...</p>
                </div>
                <button class="btn-small btn-delete" onclick="clearCCLog()" style="margin-top: 1rem;">Clear Log</button>
            </div>
        </div>
    </div>

    <!-- Page Editor Modal -->
    <div class="modal" id="page-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Create Page</h2>
                <button class="modal-close" onclick="closePageEditor()">Ã—</button>
            </div>
            <label>Page Title</label>
            <input type="text" id="page-title" placeholder="My Awesome Project">
            <label>URL Slug <span class="label-hint">(letters, numbers, hyphens only)</span></label>
            <input type="text" id="page-slug" placeholder="my-awesome-project" oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9-]/g, '')">
            <label>Content <span class="label-hint">(HTML supported)</span></label>
            <textarea id="page-content" class="large" placeholder="Write your page content here...

You can use HTML tags like:
<h2>Heading</h2>
<p>Paragraph text</p>
<a href='https://example.com'>Link</a>
<img src='image-url.jpg' alt='description'>"></textarea>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closePageEditor()">Cancel</button>
                <button class="btn-primary" onclick="savePage()">Save Page</button>
            </div>
        </div>
    </div>

    <!-- Save Bar -->
    <div class="save-bar" id="save-bar" style="display: none;">
        <button class="save-btn" onclick="saveContent()">Save Home Page</button>
        <span id="save-status" class="status"></span>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCFKStIkbW_omKXd7TQb3jUVuBJA4g3zqo",
            authDomain: "scottfriedman-f400d.firebaseapp.com",
            databaseURL: "https://scottfriedman-f400d-default-rtdb.firebaseio.com",
            projectId: "scottfriedman-f400d",
            storageBucket: "scottfriedman-f400d.firebasestorage.app",
            messagingSenderId: "1046658110090",
            appId: "1:1046658110090:web:49a24a0ff13b19cb111373"
        };

        const PASSWORD = atob('cWpuTmdraTFST25E');

        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();

        // Auth
        function login() {
            if (document.getElementById('password-input').value === PASSWORD) {
                localStorage.setItem('admin_auth', 'true');
                showAdmin();
            } else {
                document.getElementById('login-error').textContent = 'Wrong password';
            }
        }

        function logout() {
            localStorage.removeItem('admin_auth');
            location.reload();
        }

        function showAdmin() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('save-bar').style.display = 'flex';
            loadCurrentContent();
            loadPages();
            loadCommandCenter();
        }

        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        if (localStorage.getItem('admin_auth') === 'true') showAdmin();

        // Tabs
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        // Defaults
        const DEFAULTS = {
            about: { paragraphs: [
                "Hi, I'm Scott. I like building things on the internet, digging for records, and making playlists for no one in particular. Currently based somewhere with decent coffee.",
                "This is my corner of the web. It's simple on purpose."
            ]},
            projects: [
                { title: "project one", desc: "a thing that does something cool", link: "#" },
                { title: "project two", desc: "another thing, equally cool", link: "#" },
                { title: "project three", desc: "weekend experiment gone right", link: "#" },
                { title: "side quest", desc: "still figuring this one out", link: "#" }
            ],
            writing: [
                { date: "2024.12", title: "on finding your creative rhythm", link: "#" },
                { date: "2024.11", title: "the joy of building useless things", link: "#" },
                { date: "2024.10", title: "music discovery in the algorithm age", link: "#" }
            ],
            sounds: [
                { title: "Latest Mix", type: "mixcloud", url: "https://player-widget.mixcloud.com/widget/iframe/?hide_cover=1&mini=1&feed=%2Ffriedmannn%2F", artist: "" }
            ],
            contact: [
                { name: "mixcloud", url: "https://www.mixcloud.com/friedmannn/" },
                { name: "github", url: "#" },
                { name: "email", url: "#" }
            ]
        };

        let projects = [], writing = [], sounds = [], contact = [], pages = [];
        let editingPageSlug = null;
        let sectionOrder = ['about', 'projects', 'writing', 'sounds', 'contact'];

        function loadCurrentContent() {
            db.ref('content').once('value').then((snapshot) => {
                const data = snapshot.val() || DEFAULTS;

                // Load section order
                sectionOrder = data.sectionOrder || ['about', 'projects', 'writing', 'sounds', 'contact'];

                // Store about paragraphs
                window.aboutParas = (data.about?.paragraphs) || DEFAULTS.about.paragraphs;

                projects = data.projects?.length ? data.projects : DEFAULTS.projects;
                writing = data.writing?.length ? data.writing : DEFAULTS.writing;
                // Support legacy mixes format, convert to sounds
                if (data.sounds?.length) {
                    sounds = data.sounds;
                } else if (data.mixes?.length) {
                    sounds = data.mixes.map(m => ({ title: m.title || '', type: 'mixcloud', url: m.embedUrl || '', artist: '' }));
                } else {
                    sounds = DEFAULTS.sounds;
                }
                contact = data.contact?.length ? data.contact : DEFAULTS.contact;

                renderSections();
            }).catch(() => {
                window.aboutParas = DEFAULTS.about.paragraphs;
                projects = DEFAULTS.projects;
                writing = DEFAULTS.writing;
                sounds = DEFAULTS.sounds;
                contact = DEFAULTS.contact;
                renderSections();
            });
        }

        // Render all sections in order
        function renderSections() {
            const container = document.getElementById('sections-container');
            container.innerHTML = sectionOrder.map(section => getSectionHTML(section)).join('');

            // Render items within each section
            if (document.getElementById('projects-container')) renderProjectItems();
            if (document.getElementById('writing-container')) renderWritingItems();
            if (document.getElementById('sounds-container')) renderSoundItems();
            if (document.getElementById('contact-container')) renderContactItems();
        }

        function getSectionHTML(section) {
            const idx = sectionOrder.indexOf(section) + 1;
            const orderControls = `
                <div class="section-order-controls">
                    <button class="section-order-btn" onclick="moveSectionUp('${section}')" title="Move up">â–²</button>
                    <input type="number" class="section-order-input" value="${idx}" min="1" max="${sectionOrder.length}"
                           onchange="moveSectionTo('${section}', this.value)">
                    <button class="section-order-btn" onclick="moveSectionDown('${section}')" title="Move down">â–¼</button>
                </div>`;

            switch(section) {
                case 'about':
                    return `
                        <div class="section" data-section="about">
                            ${orderControls}
                            <h2>About</h2>
                            <label>Paragraph 1</label>
                            <textarea id="about-p1" placeholder="First paragraph...">${esc(window.aboutParas?.[0] || '')}</textarea>
                            <label>Paragraph 2</label>
                            <textarea id="about-p2" placeholder="Second paragraph...">${esc(window.aboutParas?.[1] || '')}</textarea>
                        </div>`;
                case 'projects':
                    return `
                        <div class="section" data-section="projects">
                            ${orderControls}
                            <h2>Projects</h2>
                            <p style="color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
                                Link to external URLs or internal pages you create in the Pages tab
                            </p>
                            <div id="projects-container"></div>
                            <button class="add-btn" onclick="addProject()">+ Add Project</button>
                        </div>`;
                case 'writing':
                    return `
                        <div class="section" data-section="writing">
                            ${orderControls}
                            <h2>Writing</h2>
                            <div id="writing-container"></div>
                            <button class="add-btn" onclick="addWriting()">+ Add Post</button>
                        </div>`;
                case 'sounds':
                    return `
                        <div class="section" data-section="sounds">
                            ${orderControls}
                            <h2>Sounds</h2>
                            <p style="color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
                                Add audio from Mixcloud, Bandcamp, Dropbox, or direct audio URLs
                            </p>
                            <div id="sounds-container"></div>
                            <button class="add-btn" onclick="addSound()">+ Add Sound</button>
                        </div>`;
                case 'contact':
                    return `
                        <div class="section" data-section="contact">
                            ${orderControls}
                            <h2>Contact Links</h2>
                            <div id="contact-container"></div>
                            <button class="add-btn" onclick="addContact()">+ Add Link</button>
                        </div>`;
                default:
                    return '';
            }
        }

        function moveSectionUp(section) {
            const idx = sectionOrder.indexOf(section);
            if (idx > 0) {
                sectionOrder.splice(idx, 1);
                sectionOrder.splice(idx - 1, 0, section);
                renderSections();
            }
        }

        function moveSectionDown(section) {
            const idx = sectionOrder.indexOf(section);
            if (idx < sectionOrder.length - 1) {
                sectionOrder.splice(idx, 1);
                sectionOrder.splice(idx + 1, 0, section);
                renderSections();
            }
        }

        function moveSectionTo(section, newPos) {
            const pos = parseInt(newPos) - 1;
            if (pos < 0 || pos >= sectionOrder.length) return;
            const idx = sectionOrder.indexOf(section);
            sectionOrder.splice(idx, 1);
            sectionOrder.splice(pos, 0, section);
            renderSections();
        }


        // Projects
        function renderProjects() { renderProjectItems(); }
        function renderProjectItems() {
            const container = document.getElementById('projects-container');
            if (!container) return;
            container.innerHTML = projects.map((p, i) => `
                <div class="item" data-type="projects" data-index="${i}">
                    <div class="order-controls">
                        <button class="order-btn" onclick="moveItemUp('projects', ${i})" title="Move up">â–²</button>
                        <input type="number" class="order-input" value="${i + 1}" min="1" max="${projects.length}"
                               onchange="moveItemTo('projects', ${i}, this.value)">
                        <button class="order-btn" onclick="moveItemDown('projects', ${i})" title="Move down">â–¼</button>
                    </div>
                    <div class="item-header">
                        <span class="item-title">Project ${i + 1}</span>
                        <button class="remove-btn" onclick="removeProject(${i})">Ã—</button>
                    </div>
                    <input type="text" placeholder="Title" value="${esc(p.title)}" onchange="projects[${i}].title = this.value">
                    <input type="text" placeholder="Description" value="${esc(p.desc)}" onchange="projects[${i}].desc = this.value">
                    <div class="inline-fields">
                        <input type="text" placeholder="Link URL (external) or page slug (internal)" value="${esc(p.link)}" onchange="projects[${i}].link = this.value">
                    </div>
                </div>
            `).join('');
        }
        function addProject() { projects.push({ title: '', desc: '', link: '' }); renderProjectItems(); }
        function removeProject(i) { projects.splice(i, 1); renderProjectItems(); }

        // Writing
        function renderWriting() { renderWritingItems(); }
        function renderWritingItems() {
            const container = document.getElementById('writing-container');
            if (!container) return;
            container.innerHTML = writing.map((w, i) => `
                <div class="item" data-type="writing" data-index="${i}">
                    <div class="order-controls">
                        <button class="order-btn" onclick="moveItemUp('writing', ${i})" title="Move up">â–²</button>
                        <input type="number" class="order-input" value="${i + 1}" min="1" max="${writing.length}"
                               onchange="moveItemTo('writing', ${i}, this.value)">
                        <button class="order-btn" onclick="moveItemDown('writing', ${i})" title="Move down">â–¼</button>
                    </div>
                    <div class="item-header">
                        <span class="item-title">Post ${i + 1}</span>
                        <button class="remove-btn" onclick="removeWriting(${i})">Ã—</button>
                    </div>
                    <div class="inline-fields">
                        <input type="text" placeholder="Date (e.g., 2024.12)" value="${esc(w.date)}" onchange="writing[${i}].date = this.value" style="max-width: 120px;">
                        <input type="text" placeholder="Title" value="${esc(w.title)}" onchange="writing[${i}].title = this.value">
                    </div>
                    <input type="text" placeholder="Link URL or page slug" value="${esc(w.link)}" onchange="writing[${i}].link = this.value">
                </div>
            `).join('');
        }
        function addWriting() { writing.push({ date: '', title: '', link: '' }); renderWritingItems(); }
        function removeWriting(i) { writing.splice(i, 1); renderWritingItems(); }

        // Sounds
        function renderSounds() { renderSoundItems(); }
        function renderSoundItems() {
            const container = document.getElementById('sounds-container');
            if (!container) return;
            container.innerHTML = sounds.map((s, i) => `
                <div class="item" data-type="sounds" data-index="${i}">
                    <div class="order-controls">
                        <button class="order-btn" onclick="moveItemUp('sounds', ${i})" title="Move up">â–²</button>
                        <input type="number" class="order-input" value="${i + 1}" min="1" max="${sounds.length}"
                               onchange="moveItemTo('sounds', ${i}, this.value)">
                        <button class="order-btn" onclick="moveItemDown('sounds', ${i})" title="Move down">â–¼</button>
                    </div>
                    <div class="item-header">
                        <span class="item-title">Sound ${i + 1}</span>
                        <button class="remove-btn" onclick="removeSound(${i})">Ã—</button>
                    </div>
                    <div class="inline-fields">
                        <input type="text" placeholder="Title" value="${esc(s.title)}" onchange="sounds[${i}].title = this.value">
                        <input type="text" placeholder="Artist (optional)" value="${esc(s.artist || '')}" onchange="sounds[${i}].artist = this.value" style="max-width: 150px;">
                    </div>
                    <div class="inline-fields">
                        <select onchange="sounds[${i}].type = this.value; updateSoundHelp(${i})">
                            <option value="mixcloud" ${s.type === 'mixcloud' ? 'selected' : ''}>Mixcloud</option>
                            <option value="bandcamp" ${s.type === 'bandcamp' ? 'selected' : ''}>Bandcamp</option>
                            <option value="dropbox" ${s.type === 'dropbox' ? 'selected' : ''}>Dropbox</option>
                            <option value="audio" ${s.type === 'audio' ? 'selected' : ''}>Direct Audio</option>
                        </select>
                        <input type="text" id="sound-url-${i}" placeholder="${getSoundPlaceholder(s.type)}" value="${esc(s.url)}" onchange="sounds[${i}].url = this.value">
                    </div>
                    <p id="sound-help-${i}" style="color: #999; font-size: 0.75rem; margin: 0;">${getSoundHelp(s.type)}</p>
                </div>
            `).join('');
        }
        function getSoundPlaceholder(type) {
            switch(type) {
                case 'mixcloud': return 'Mixcloud embed URL';
                case 'bandcamp': return 'Bandcamp embed URL';
                case 'dropbox': return 'Dropbox share link';
                case 'audio': return 'Direct audio URL (.mp3, .wav)';
                default: return 'URL';
            }
        }
        function getSoundHelp(type) {
            switch(type) {
                case 'mixcloud': return 'Share â†’ Embed â†’ copy the src URL from the iframe';
                case 'bandcamp': return 'Share/Embed â†’ copy the src URL from the iframe';
                case 'dropbox': return 'Paste the share link (e.g., dropbox.com/s/...) - it will auto-convert';
                case 'audio': return 'Direct link to an audio file';
                default: return '';
            }
        }
        function updateSoundHelp(i) {
            const type = sounds[i].type;
            document.getElementById(`sound-url-${i}`).placeholder = getSoundPlaceholder(type);
            document.getElementById(`sound-help-${i}`).textContent = getSoundHelp(type);
        }
        function addSound() { sounds.push({ title: '', type: 'mixcloud', url: '', artist: '' }); renderSoundItems(); }
        function removeSound(i) { sounds.splice(i, 1); renderSoundItems(); }

        // Contact
        function renderContact() { renderContactItems(); }
        function renderContactItems() {
            const container = document.getElementById('contact-container');
            if (!container) return;
            container.innerHTML = contact.map((c, i) => `
                <div class="item" data-type="contact" data-index="${i}">
                    <div class="order-controls">
                        <button class="order-btn" onclick="moveItemUp('contact', ${i})" title="Move up">â–²</button>
                        <input type="number" class="order-input" value="${i + 1}" min="1" max="${contact.length}"
                               onchange="moveItemTo('contact', ${i}, this.value)">
                        <button class="order-btn" onclick="moveItemDown('contact', ${i})" title="Move down">â–¼</button>
                    </div>
                    <div class="item-header">
                        <span class="item-title">Link ${i + 1}</span>
                        <button class="remove-btn" onclick="removeContact(${i})">Ã—</button>
                    </div>
                    <div class="inline-fields">
                        <input type="text" placeholder="Name (e.g., github)" value="${esc(c.name)}" onchange="contact[${i}].name = this.value" style="max-width: 150px;">
                        <input type="text" placeholder="URL" value="${esc(c.url)}" onchange="contact[${i}].url = this.value">
                    </div>
                </div>
            `).join('');
        }
        function addContact() { contact.push({ name: '', url: '' }); renderContactItems(); }
        function removeContact(i) { contact.splice(i, 1); renderContactItems(); }

        // Item reordering functions
        function getItemArray(type) {
            switch(type) {
                case 'projects': return projects;
                case 'writing': return writing;
                case 'sounds': return sounds;
                case 'contact': return contact;
            }
            return null;
        }

        function reRenderItems(type) {
            switch(type) {
                case 'projects': renderProjectItems(); break;
                case 'writing': renderWritingItems(); break;
                case 'sounds': renderSoundItems(); break;
                case 'contact': renderContactItems(); break;
            }
        }

        function moveItemUp(type, index) {
            const arr = getItemArray(type);
            if (!arr || index <= 0) return;
            const [item] = arr.splice(index, 1);
            arr.splice(index - 1, 0, item);
            reRenderItems(type);
        }

        function moveItemDown(type, index) {
            const arr = getItemArray(type);
            if (!arr || index >= arr.length - 1) return;
            const [item] = arr.splice(index, 1);
            arr.splice(index + 1, 0, item);
            reRenderItems(type);
        }

        function moveItemTo(type, fromIndex, newPos) {
            const arr = getItemArray(type);
            const toIndex = parseInt(newPos) - 1;
            if (!arr || toIndex < 0 || toIndex >= arr.length || fromIndex === toIndex) return;
            const [item] = arr.splice(fromIndex, 1);
            arr.splice(toIndex, 0, item);
            reRenderItems(type);
        }

        // Pages
        function loadPages() {
            db.ref('pages').once('value').then((snapshot) => {
                pages = [];
                snapshot.forEach((child) => {
                    pages.push({ slug: child.key, ...child.val() });
                });
                renderPages();
            });
        }

        function renderPages() {
            const container = document.getElementById('pages-list');
            if (pages.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">No pages yet. Create your first page!</p>';
                return;
            }
            container.innerHTML = pages.map(p => `
                <div class="page-item">
                    <div class="page-item-info">
                        <div class="page-item-title">${esc(p.title)}</div>
                        <div class="page-item-slug">page.html?p=${p.slug}</div>
                    </div>
                    <div class="page-item-actions">
                        <button class="btn-small btn-edit" onclick="editPage('${p.slug}')">Edit</button>
                        <button class="btn-small btn-delete" onclick="deletePage('${p.slug}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function openPageEditor(slug = null) {
            editingPageSlug = slug;
            document.getElementById('modal-title').textContent = slug ? 'Edit Page' : 'Create Page';

            if (slug) {
                const page = pages.find(p => p.slug === slug);
                document.getElementById('page-title').value = page?.title || '';
                document.getElementById('page-slug').value = slug;
                document.getElementById('page-slug').disabled = true;
                document.getElementById('page-content').value = page?.content || '';
            } else {
                document.getElementById('page-title').value = '';
                document.getElementById('page-slug').value = '';
                document.getElementById('page-slug').disabled = false;
                document.getElementById('page-content').value = '';
            }

            document.getElementById('page-modal').classList.add('active');
        }

        function closePageEditor() {
            document.getElementById('page-modal').classList.remove('active');
            editingPageSlug = null;
        }

        function editPage(slug) {
            openPageEditor(slug);
        }

        function savePage() {
            const title = document.getElementById('page-title').value.trim();
            const slug = document.getElementById('page-slug').value.trim();
            const content = document.getElementById('page-content').value;

            if (!title || !slug) {
                alert('Please fill in title and slug');
                return;
            }

            db.ref('pages/' + slug).set({ title, content })
                .then(() => {
                    closePageEditor();
                    loadPages();
                })
                .catch(err => alert('Error: ' + err.message));
        }

        function deletePage(slug) {
            if (!confirm('Delete this page?')) return;
            db.ref('pages/' + slug).remove().then(() => loadPages());
        }

        // Save home content
        function saveContent() {
            const status = document.getElementById('save-status');
            status.textContent = 'Saving...';
            status.className = 'status';

            const content = {
                sectionOrder: sectionOrder,
                about: { paragraphs: [
                    document.getElementById('about-p1')?.value || '',
                    document.getElementById('about-p2')?.value || ''
                ].filter(p => p.trim()) },
                projects: projects.filter(p => p.title.trim()),
                writing: writing.filter(w => w.title.trim()),
                sounds: sounds.filter(s => s.url.trim()),
                contact: contact.filter(c => c.name.trim())
            };

            db.ref('content').set(content)
                .then(() => {
                    status.textContent = 'Saved!';
                    status.className = 'status success';
                    setTimeout(() => { status.textContent = ''; }, 2000);
                })
                .catch(err => {
                    status.textContent = 'Error: ' + err.message;
                    status.className = 'status error';
                });
        }

        function esc(str) { return (str || '').replace(/"/g, '&quot;').replace(/</g, '&lt;'); }

        // ==================== Command Center ====================

        let ccEnabled = false;
        let ccDevices = [];

        function loadCommandCenter() {
            // Load enabled state
            db.ref('commandcenter/enabled').on('value', (snapshot) => {
                ccEnabled = snapshot.val() === true;
                updateCCToggleUI();
            });

            // Load devices
            db.ref('commandcenter/devices').once('value').then((snapshot) => {
                const data = snapshot.val() || {};
                ccDevices = Object.entries(data).map(([key, device]) => ({
                    entityId: device.entity_id || decodeFirebaseKey(key),
                    name: device.name,
                    emoji: device.emoji,
                    type: device.type,
                    enabled: device.enabled !== false // Default to true
                }));
                renderCCDevices();
            });

            // Load activity log
            db.ref('commandcenter/log')
                .orderByChild('timestamp')
                .limitToLast(20)
                .on('value', (snapshot) => {
                    renderCCActivityLog(snapshot.val());
                });
        }

        function updateCCToggleUI() {
            const btn = document.getElementById('cc-toggle-btn');
            const status = document.getElementById('cc-status');
            if (ccEnabled) {
                btn.textContent = 'Disable';
                btn.style.background = '#c45d3a';
                btn.style.color = 'white';
                status.textContent = 'Visitors can control your devices';
            } else {
                btn.textContent = 'Enable';
                btn.style.background = '#2d5a3d';
                btn.style.color = 'white';
                status.textContent = 'Controls are hidden from visitors';
            }
        }

        function toggleCommandCenter() {
            db.ref('commandcenter/enabled').set(!ccEnabled);
        }

        function renderCCDevices() {
            const container = document.getElementById('cc-devices-container');
            if (ccDevices.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 1rem;">No devices configured. Add one below!</p>';
                return;
            }
            container.innerHTML = ccDevices.map((d, i) => {
                const isEnabled = d.enabled !== false; // Default to enabled
                return `
                <div class="item" style="${!isEnabled ? 'opacity: 0.6;' : ''}">
                    <div class="item-header">
                        <span class="item-title">${d.emoji || 'ðŸ”Œ'} ${d.name || 'Device ' + (i+1)}</span>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button class="btn-small" onclick="toggleCCDeviceEnabled(${i})"
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: ${isEnabled ? '#2d5a3d' : '#999'}; color: white;">
                                ${isEnabled ? 'Enabled' : 'Disabled'}
                            </button>
                            <button class="remove-btn" onclick="removeCCDevice(${i})">Ã—</button>
                        </div>
                    </div>
                    <div class="inline-fields">
                        <input type="text" placeholder="Entity ID (e.g., light.bedroom)" value="${esc(d.entityId)}"
                               onchange="ccDevices[${i}].entityId = this.value">
                        <input type="text" placeholder="Emoji" value="${esc(d.emoji || '')}"
                               onchange="ccDevices[${i}].emoji = this.value" style="max-width: 60px;">
                    </div>
                    <div class="inline-fields">
                        <input type="text" placeholder="Display Name" value="${esc(d.name || '')}"
                               onchange="ccDevices[${i}].name = this.value">
                        <select onchange="ccDevices[${i}].type = this.value" style="max-width: 120px;">
                            <option value="light" ${d.type === 'light' ? 'selected' : ''}>Light</option>
                            <option value="switch" ${d.type === 'switch' ? 'selected' : ''}>Switch</option>
                            <option value="fan" ${d.type === 'fan' ? 'selected' : ''}>Fan</option>
                        </select>
                    </div>
                </div>
            `}).join('');
        }

        function toggleCCDeviceEnabled(i) {
            ccDevices[i].enabled = ccDevices[i].enabled === false ? true : false;
            renderCCDevices();
        }

        function addCCDevice() {
            ccDevices.push({ entityId: '', name: '', emoji: 'ðŸ’¡', type: 'light' });
            renderCCDevices();
        }

        function removeCCDevice(i) {
            ccDevices.splice(i, 1);
            renderCCDevices();
        }

        // Firebase keys can't contain dots, so we encode entity_ids
        function encodeFirebaseKey(key) {
            return key.replace(/\./g, '__');
        }
        function decodeFirebaseKey(key) {
            return key.replace(/__/g, '.');
        }

        function saveCCDevices() {
            const status = document.getElementById('cc-save-status');
            status.textContent = 'Saving...';
            status.className = 'status';

            // Convert array to object keyed by encoded entityId
            const devicesObj = {};
            ccDevices.filter(d => d.entityId.trim()).forEach(d => {
                const key = encodeFirebaseKey(d.entityId);
                devicesObj[key] = {
                    entity_id: d.entityId, // Store actual entity_id as field
                    name: d.name || d.entityId,
                    emoji: d.emoji || 'ðŸ”Œ',
                    type: d.type || 'switch',
                    enabled: d.enabled !== false // Default to true
                };
            });

            db.ref('commandcenter/devices').set(devicesObj)
                .then(() => {
                    status.textContent = 'Saved!';
                    status.className = 'status success';
                    setTimeout(() => { status.textContent = ''; }, 2000);
                })
                .catch(err => {
                    status.textContent = 'Error: ' + err.message;
                    status.className = 'status error';
                });
        }

        function renderCCActivityLog(logs) {
            const container = document.getElementById('cc-activity-log');
            if (!logs) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No activity yet</p>';
                return;
            }

            const logArray = Object.entries(logs)
                .map(([key, val]) => ({ key, ...val }))
                .sort((a, b) => b.timestamp - a.timestamp);

            container.innerHTML = logArray.map(log => {
                const time = new Date(log.timestamp).toLocaleString();
                const actionColor = log.action === 'turn_on' ? '#2d5a3d' : '#c45d3a';
                return `
                    <div style="padding: 0.5rem; border-bottom: 1px solid #eee; font-size: 0.85rem;">
                        <span style="color: ${actionColor}; font-weight: 500;">
                            ${log.action === 'turn_on' ? 'ON' : 'OFF'}
                        </span>
                        <span style="color: #333;">${log.deviceName || log.entity_id}</span>
                        <span style="color: #999; font-size: 0.75rem; float: right;">${time}</span>
                    </div>
                `;
            }).join('');
        }

        function clearCCLog() {
            if (!confirm('Clear all activity logs?')) return;
            db.ref('commandcenter/log').remove();
        }
    </script>
</body>
</html>
